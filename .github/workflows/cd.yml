name: CI/CD
on:
  # push:
  #   branches: [main]
  # pull_request:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release'
        required: true
        default: 'patch'

env:
  PUBLISH_TO_TEST_PYPI: true
  PUBLISH_TO_PYPI: false

jobs:
  ci:
    uses: ./.github/workflows/ci.yml  # use the callable tests job to run tests
  build:
    name: build
    needs: [ci]
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.8", "3.9", "3.10"]
        os: [ubuntu-latest]
    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        python-version: ${{ matrix.python-version }}
        enable-cache: true
    - name: Set up Python
      run: uv python install
    - name: Install the project
      run: uv sync

    - name: Build package
      run: uv build --out-dir dist-${{ matrix.python-version }}

    - name: Upload built package
      uses: actions/upload-artifact@v4
      with:
        name: dist-${{ matrix.python-version }}
        path: dist-${{ matrix.python-version }}/
        retention-days: 1
  cd:
    name: cd
    needs: [ci, build]
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Download built package
      uses: actions/download-artifact@v4
      with:
        name: dist-3.10
        path: dist-3.10
    - name: Install uv
      uses: astral-sh/setup-uv@v5
      env:
        UV_PUBLISH_TOKEN: ${{ secrets.PYPI_TEST_API_TOKEN }}
        UV_INDEX_URL: https://test.pypi.org/legacy/
    - name: "Check if Test.PyPI Token exists"
      if: ${{ env.UV_PUBLISH_TOKEN == '' }}
      run: |
        echo "the secret \'PYPI_TEST_API_TOKEN\' has not been made"
        echo "Please go to \'settings \> secrets \> actions\' to create it"
        exit 1
    - name: Publish distribution ðŸ“¦ to Test PyPI
      run: uv publish --publish-url $UV_INDEX_URL dist-3.10/* -t $UV_PUBLISH_TOKEN
